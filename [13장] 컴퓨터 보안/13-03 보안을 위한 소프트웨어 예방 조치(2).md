# 보안을 위한 소프트웨어 예방 조치(2)

## 네 코드를 알라

규모가 큰 프로젝트에는 `서드파티 코드(third-party code)`가 들어가는 경우가 있다.

> **서드파티 코드 (third-party code)**
> 프로젝트 팀이 아닌 제 3자가 작성한 코드

서드 파티 코드를 사용할 때는 다음과 같은 `문제`가 생길 수 있다.

- 서브 파티 코드의 소스 코드에 접근할 수 없을 때도 있다. 이 경우에는 코드가 안전하고 잘 작동하는지 알 수가 없다. `백도어`가 설치되어 있는지도 알 수 없다.
- `디지털 헤르페스`: 시스템 통합가에 의해 소프트웨어를 구축할 때 제품에 쓰이지 않는 코드가 제품에 포함될 수 있다.

이런 문제를 `해결`하려면 어떻게 해야할까?

- `오픈 소스 코드`가 더 나을 수 있다.
  - 여러 사람이 살펴보기 때문에 버그를 발견할 가능성이 더 높다.
- 제 3자 패키지에서 실제 사용하는 코드 크기와 전체 패키지 크기 사이의 `비율`을 주시한다.
  - 실제로 사용하지 않을 많은 기능까지 포함하면서 패키지를 사용하기 보다는 필요한 코드를 직접 작성하는 것이 나을 수 있다.
- 디버깅을 위한 코드는 꼭 제거한다.
  <br />

## 극단적인 영리함은 여러분의 적이다

서드파티 코드 사용 시 사람들이 많이 쓰지 않는 기능은 사용하지 않는 것이 좋다.
많이 사용하지 않으므로 벤더가 더 이상 지원하지 않고, 그러면 서드파티 코드가 업그레이드 되지 않아 보안 버그를 수정한 버그 픽스를 설치하지 못할 수 있다.
<br />

## 눈에 보이는 것을 이해하라

민감한 데이터는 우리의 프로그램이 아닌 다른 프로그램이 접근할 수 있는지 생각해보자. 이런 부분을 통해 `위협 모델`을 정의할 수 있다.
코드를 작성하는 일 외에도 `사이드 채널 공격`에 주의를 기울여야 한다.

> **사이드 채널 공격**
> 프로그램 구현의 메타 데이터나 부작용에 기반을 둔 공격 방법

- **타이밍 공격**

  - ex) 암호 검사하는 코드가 있을 때 틀린 암호를 검사하는 것보다 올바를 암호에 가까운 암호를 검사할 때 시간이 더 걸리면 공격자에게 힌트를 주는 것과 같다.

- **반 에크 프리킹**
  - 안테나를 사용해 모니터 방사파를 잡아내 모니터에 표시된 이미지를 원격에서 재현하는 방법
  - ex) 전자 투표 시스템에 사용하면 비밀 투표를 무력화시킬 수 있다.

이런 사이드 채널 공격을 방지하기 위해서 중요한 보안 코드에 대해서 실제 내부에서 일어나는 일을 외부에서 관찰할 수 없도록 해야한다. 즉 사이드 채널을 통해 정보를 노출하는 일이 없게 해야 한다.

<br />

## 과다수집하지 마라

정말 필요한 경우를 제외하고 민감한 정보를 수집하지 않는다.
<br />

## 모아두지 마라

민감한 정보는 가능한 한 빨리 없애는 것이 낫다.
ex) 패스워드는 확인 후 더이상 필요하지 않으므로 오래 저장하지 않는다.
<br />

## 동적 메모리 할당은 여러분의 친구가 아니다

- `malloc()` : 메모리를 할당하는 함수
- `free()` 메모리를 해제하는 함수
- `realloc()`: 할당된 메모리의 크기를 늘리거나 줄이는 함수
  <br />
- **메모리를 해제하기 전에 민감한 정보를 지워야 한다.** <br />
  ![그림 13-7](https://media.discordapp.net/attachments/879215554379018243/1010602652058517524/unknown.png)
  - 그림 13-7을 보면 메모리가 해제되고 나서도 민감한 정보가 계속 존재한다. 따라서 해제하기 전 민감한 정보를 지워야 한다.
- **메모리를 줄이는 경우 그에 따라 반환될 영역에 있는 정보를 지워야 한다.**<br />
  ![그림 13-8](https://media.discordapp.net/attachments/879215554379018243/1010602745759289383/unknown.png)

  - 그림 13-8을 보면 할당된 메모리가 줄어들면, 메모리 영역 밖의 힙으로 비밀정보가 돌아간다. 따라서 반환될 영역에 있는 정보를 지워야 한다.

- **보안이 필수적인 경우 realloc을 사용하지 않는다.**<br />
  ![그림 13-10](https://media.discordapp.net/attachments/879215554379018243/1010602808095019129/unknown.png)
  - 그림 13-10에서 메모리 블록을 키우려고 했는데 다른 블록으로 인해 충분한 공간이 없다. 이 경우 힙에서 충분한 크기의 연속된 메모리 공간을 찾고, 메모리를 할당한다. 이 경우 비밀정보의 복사본이 2본 존재하고, 하나는 할당될 수 있는 힙의 영역에 위치하게 된다.
  - malloc으로 새 메모리를 할당하고, 이전 데이터를 새 블록에 복사한 다음 민감한 데이터를 덮어 씌우고, free로 해제해야 한다.

<br />

## 가비지 컬렉션도 여러분의 친구가 아니다.

중요한 데이터가 불필요하면 지우는 것이 좋다. 그런데 가비지 컬렉션을 사용하면 다음과 같은 문제가 발생한다.

- 중요한 정보인 문자열을 지울 때, 새로운 문자열을 할당한 다음, 민감한 정보가 담긴 문자열은 가비지 컬렉션이 가능한 문자열로 분류한다. 이러면 민감한 정보는 지워지지 않고, 강제로 지울 방법도 없다.

- 플래시 메모리 사용 시 (그 중에서도 SSD), 플래시 메모리 칩에 데이터를 분산해 저장하는 `부하 평탄화` 기능이 들어간다. 즉 어떤 데이터를 기록해도 예전 정보를 덮어쓰지 않는다. 할당된 메모리를 해제해서 그 메모리가 힙의 사용 가능 영역에 남게 되는 것과 비슷하다.

<br />

## 코드 역할을 하는 데이터

- **받는 입력이 코드로 해석되어서는 안된다.**
  - 예를 들면 댓글을 입력할 때 자바스크립트 코드가 입력되면, 이를 확인하는 사용자가 의도치 않게 코드를 실행할 수 있다.
  - 댓글에 html을 사용하도록 허용하면 댓글창이 광고 혹은 다른 웹사이트의 링크로 가득 찰 수 있다.
- **SQL 주입 공격**

  ```sql
  SELECT * FROM students WHERE class = '{$_REQUEST['class']}', && student='$student'
  ```

  위와 같은 SQL 문이 있다. class는 요청받은 class 입력 값과, 로그인 한 학생의 이름과 같은 값을 찾는 SQL문이다.

  그런데 사용자가 class에 `Biology`라는 과목 이름이 아니라 `'Biology' || 1=1 || '; #`을 입력하였다.

  ```sql
  SELECT * FROM students WHERE class = 'Biology' || 1=1 || ''; #, && student='David Lightman'
  ```

  이렇게 되면 #이후는 주석 처리가 되고, 1=1이라는 조건이 항상 성립하므로 David의 정보가 아닌 모든 학생들의 정보를 얻을 수 있다.

  이 뿐만 아니라 세미콜론 뒤에 데이터베이스를 갱신하는 SQL 명령을 더 입력할 수 있다.
