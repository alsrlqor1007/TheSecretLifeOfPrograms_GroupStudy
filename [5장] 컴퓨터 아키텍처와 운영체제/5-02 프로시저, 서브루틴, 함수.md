# 프로시저, 서브루틴, 함수

### 코드의 재사용

**함수(function, 혹은 프로시저(procedure), 혹은 서브루틴(subroutine))**

- 코드를 재사용하는 주요 수단.
- 코드가 차지하는 메모리를 줄이고, 버그가 있는 경우 여러 부분을 고치지 않고 한 군대만 고치면 된다는 장점이 있다.

ex) 자바스크립트 함수

```javascript
function cube(x) {
  return x * x * x;
}
```

이렇게 함수를 작성해 아래와 같이 프로그램을 작성할 수 있다.

```javascript
y = cube(3);
```

여기서 우리는 cube를 여러 번 작성하지 않아도 이 함수를 여러 번 **호출**(call, invoke)할 수 있다.

이러한 코드는 어떻게 작동하는걸까?
<br />

**함수 호출하기**
명령어 집합을 통해 함수를 호출하는 방법을 알아보자

| 주소 | 명령어 | 피연산자  | 설명                                                           |
| ---- | ------ | --------- | -------------------------------------------------------------- |
| 100  | pca    |           | 프로그램 카운터 => 누산기                                      |
| 101  | add    | 5(즉시)   | 함수에서 돌아올 주소(100 + 5 = 105)                            |
| 102  | store  | 200(직접) | 돌아올 주소를 메모리(200번지)에 저장                           |
| 103  | load   | 3(즉시)   | 세제곱할 값(함수의 파라미터값)을 누산기에 넣기                 |
| 104  | bra    | 300(직접) | cube함수를 호출(분기)                                          |
| 105  |        |           | 함수에서 돌아온 뒤 실행될 부분                                 |
| ...  |        |           |                                                                |
| 200  |        |           | 함수에서 돌아올 주소를 저장하기 위해 미리 확보해둔 메모리 위치 |
| ...  |        |           |                                                                |
| 300  |        |           | cube 함수의 시작 부분                                          |
| ...  |        |           | cube 함수의 나머지 명령어들                                    |
| 310  | bra    | 200(간접) | 저장했던 주소로 돌아감(간접 주소 지정을 사용해 분기)           |

![함수 호출 흐름](https://cdn.discordapp.com/attachments/879215554379018243/985184912686587935/IMG_9622.png)

1. 101: 함수에서 `돌아올 주소`를 계산
2. 102: 돌아올 주소를 메모리 `200번지`에 저장
3. 103: 함수 `파라미터값`을 `누산기`에 넣기
4. 104: cube 함수 `호출`
5. 300~: cube 함수의 시작 부분 ~~ 나머지 모든 코드를 실행
6. 310: 돌아올 주소를 저장했던 주소(200번지)로 돌아감
7. 200: 저장된 값을 사용해 `간접 분기`(=> 105번지)
8. 105: 함수에서 돌아온 뒤 실행 부분
   <br />

이 과정에 상당히 많은 작업이 필요하고, 기계는 이런 과정을 돕는 명령어를 제공한다.
ex) **ARM(암) 프로세서**의 `링크 레지스터를 사용한 분기(BL, Branch with Link)` 명령어
함수로 호출하는 명령어와 현재 명령어의 다음 위치를 저장하는 명령어를 하나로 합친 것
